% uisbeamer.sty
% Licence: GNU General Public License v3 (https://www.gnu.org/licenses/gpl-3.0.en.html)
% Copyright (C) 2019 Nithiya Streethran (nmstreethran@gmail.com)

% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.

% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
% GNU General Public License for more details.

% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <https://www.gnu.org/licenses/>.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{uisbeamer}

% IMPORTANT PACKAGES --------------------------------
\usepackage{booktabs} % Allows the use of \toprule, \midrule and \bottomrule in tables
\usepackage{textcomp} % for degree sign using \textdegree
\usepackage[UKenglish]{babel}
\usepackage[ddmmyyyy]{datetime} % date format DD/MM/YYYY
\usepackage[utf8]{inputenc} % for special characters/accents

% COLOURS, GRAPHICS AND FONTS --------------------------------
\usepackage{graphicx} % Allows including images
\graphicspath{ {images/} } 
\usepackage{tikz} % for diagrams
\usetikzlibrary{positioning}
\definecolor{darkblue}{HTML}{050F42} % custom HTML colours for UiS http://uis.profilmanual.fasett.no/profilfarger-18
\definecolor{logoblue}{HTML}{0A3CA0}
\definecolor{lightblue}{HTML}{AAC6E9}
\definecolor{darkorange}{HTML}{C23E00}
\definecolor{mediumorange}{HTML}{EB5F0A}
\definecolor{lightorange}{HTML}{F09600}
\definecolor{maroon}{HTML}{661D1A}
\definecolor{beige}{HTML}{AD937D}
\definecolor{lightgrey}{HTML}{F0ECE3}
\usecolortheme[named=logoblue]{structure} % set theme colour
\setbeamertemplate{section in toc}{% 
	{\color{logoblue}\inserttocsectionnumber.}~{\color{logoblue}\textbf{\inserttocsection}}}
\setbeamertemplate{subsection in toc}{%
	\hspace{2em}{\color{logoblue}\rule[0.3ex]{3pt}{3pt}}~\inserttocsubsection\par}
\setbeamercolor{title}{fg=white}
\setbeamercolor{date}{fg=white}
\setbeamercolor{frametitle}{fg=darkblue}
\setbeamercolor{normal text}{fg=darkblue}
\setbeamercolor{example text}{fg=logoblue}
\usepackage{DejaVuSans} % font % http://www.tug.dk/FontCatalogue/ 
\usepackage{csquotes}
\usepackage{hyperxmp} 
\hypersetup{colorlinks=true,urlcolor=maroon,linkcolor=black,citecolor=mediumorange,pdfsubject={\subject},
pdfkeywords={\keywords},pdfcopyright=\copyright,pdflicenseurl=\licenseurl,pdfcontactemail=\email} % hyperlink formatting 

% BIBLIOGRAPHY ------------------- 
\usepackage[style=ieee,urldate=long]{biblatex}
\usepackage{silence} % suppress warning below 
\WarningFilter{biblatex}{Patching footnotes failed} % ^
\setbeamertemplate{bibliography item}[text] % show numerical reference 
\AtBeginBibliography{\tiny} % change bib font size 
\usepackage{xpatch} % to remove empty parentheses if year not provided for @online
\xpatchbibdriver{online}
  {\printtext[parens]{\usebibmacro{date}}}
  {\iffieldundef{year}{}{\printtext[parens]{\usebibmacro{date}}}}
  {}{} 
\renewbibmacro*{doi+eprint+url}{% % if DOI is not present, print eprint; if eprint is not present, print URL
    \printfield{doi}%
    \newunit\newblock%
    \newunit\newblock%
    \iffieldundef{doi}{%
    	\usebibmacro{eprint}%
        \iffieldundef{eprint}{%
        	\usebibmacro{url+urldate}}}%
        {}%
    }
% removes unwanted fields for all references except misc
  \AtEveryBibitem{%
    \ifboolexpr{not (test {\ifentrytype{misc}})}%
    {\clearfield{issn} }{}
	}
	\DeclareBibliographyAlias{software}{online} % remap software entries to online 
  
% TITLE PAGE FORMATTING -------------------------------------- 
% adjust title page vertical spacing 
\makeatletter
\defbeamertemplate*{title page}{mydefault}[1][]{
	\begin{columns}
		\column{.22\paperwidth}% ADJUST
		\mbox{}
		\column{.78\paperwidth}% ADJUST
		\begin{beamercolorbox}[sep=0pt,left,#1]{author}
			\vskip1.5cm
			\usebeamerfont{author}\textcolor{white}\insertauthor
		\end{beamercolorbox}
		\vskip.7cm%<- added
		\begin{beamercolorbox}[sep=0pt,left,#1]{title}
			\usebeamerfont{title}\titlesize\inserttitle\par%
			\ifx\insertsubtitle\@empty%
			\else%
			\vskip0.25em%
			{\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}%
			\fi%     
		\end{beamercolorbox}%
		\vskip.25cm\par
		\begin{beamercolorbox}[sep=0pt,left,#1]{date}
			\usebeamerfont{date}\footnotesize\date
		\end{beamercolorbox}\vskip.25em
		\begin{beamercolorbox}[sep=0pt,left,#1]{email}
			\usebeamerfont{email}\href{mailto:\email}{\texttt{\textcolor{white}\email}}
		\end{beamercolorbox}
	\end{columns}}
\setbeamertemplate{title page}[mydefault][colsep=-4bp,rounded=true,shadow=\beamer@themerounded@shadow,wd=9.5cm]% ADJUST
\makeatother
% 
\title{\prestitle} 
\subtitle{\subt}
\author{\auth} % Your name 

% FRAME TITLE FORMATTING ---------------------------------
\makeatletter 
\setbeamertemplate{frametitle}{
	\ifbeamercolorempty[bg]{frametitle}{}{\nointerlineskip}%
	\@tempdima=\textwidth%
	\advance\@tempdima by\beamer@leftmargin%
	\advance\@tempdima by\beamer@rightmargin%
	\vspace{.5cm} % ADJUST
	\hspace*{.5cm} % ADJUST
	\begin{beamercolorbox}[sep=.3cm,left,wd=\the\@tempdima]{frametitle}
		\usebeamerfont{frametitle}%
		\vbox{}\vskip-1ex%
		\if@tempswa\else\csname beamer@ftecenter\endcsname\fi%
		\strut\underline{\insertframetitle}\strut\par%
		{%
			\ifx\insertframesubtitle\@empty%
			\else%
			{\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\strut\par}%
			\fi
		}%
		\vskip-1ex%
		\if@tempswa\else\vskip-.3cm\fi% set inside beamercolorbox...
	\end{beamercolorbox}}
\makeatother

% FRAME MARGINS -----------------------
\setbeamertemplate{footline}{% 
	\vspace{.4cm}
}

% NAVIGATION SYMBOLS -----------------------------
\setbeamertemplate{navigation symbols}{}

% BACKGROUND STYLES -------------------------------
%%% title frame background
\newcommand{\titlebg}{
	\usebackgroundtemplate{ % set background before beginning frame
		\begin{tikzpicture}[remember picture,overlay,shift={(current page.north)}]
		\node[yshift=-4.5cm]{\includegraphics[width=.9\paperwidth]{background_images/sky.jpg}}; % sky background
		\node[xshift=-6.63cm,yshift=-3.5cm]{\includegraphics[scale=.065]{background_images/uis-neg.png}}; % UiS logo
		\draw [line width=1mm,white] (-4.6,-2.6) -- (5.8,-2.6);
		\node [xshift=-6cm,yshift=-.15cm]{\hskip1em\usebeamercolor[fg]{navigation symbols dimmed}%
			\insertslidenavigationsymbol% % navigation symbols in top right corner 
			\insertframenavigationsymbol% 
			\insertsectionnavigationsymbol%
			\insertsubsectionnavigationsymbol%
			\insertdocnavigationsymbol%
			\insertbackfindforwardnavigationsymbol};%
		\end{tikzpicture}
}}

%%% body frame background 
\newcommand{\bodybg}{
	\usebackgroundtemplate{ % set background before beginning frame
		\begin{tikzpicture}[remember picture,overlay,shift={(current page.north)}]
		\node [xshift=0cm,yshift=-4.5cm,rectangle,fill=beige!30,beige!30,draw,text width=14.2cm,minimum height=7.6cm,align=center] {};
		\node[xshift=6.5cm,yshift=-8.65cm]{\includegraphics[scale=.02]{background_images/uis-pos.png}}; % UiS logo
		\node [darkblue,font=\tiny,xshift=-6.5cm,yshift=-8.65cm] {\date}; % date 
		\node [darkblue,font=\tiny,xshift=0cm,yshift=-8.65cm] {\insertframenumber\,/\,\inserttotalframenumber}; % frame number
		\node [xshift=-6cm,yshift=-.15cm]{\hskip1em\usebeamercolor[fg]{navigation symbols dimmed}%
			\insertslidenavigationsymbol%
			\insertframenavigationsymbol%
			\insertsectionnavigationsymbol%
			\insertsubsectionnavigationsymbol%
			\insertdocnavigationsymbol%
			\insertbackfindforwardnavigationsymbol};%
		\end{tikzpicture}
}}

%%% backup frame background 
\newcommand{\backupbg}{
	\usebackgroundtemplate{ % set background before beginning frame
		\begin{tikzpicture}[remember picture,overlay,shift={(current page.north)}]
		\node [xshift=0cm,yshift=-4.5cm,rectangle,fill=beige!30,beige!30,draw,text width=14.2cm,minimum height=7.6cm,align=center] {};
		\node[xshift=6.5cm,yshift=-8.65cm]{\includegraphics[scale=.02]{background_images/uis-pos.png}}; % UiS logo
		\node [darkblue,font=\tiny,xshift=-6.5cm,yshift=-8.65cm] {\date}; % date 
		\node [xshift=-6cm,yshift=-.15cm]{\hskip1em\usebeamercolor[fg]{navigation symbols dimmed}%
			\insertslidenavigationsymbol%
			\insertframenavigationsymbol%
			\insertsectionnavigationsymbol%
			\insertsubsectionnavigationsymbol%
			\insertdocnavigationsymbol%
			\insertbackfindforwardnavigationsymbol};%
		\end{tikzpicture}
}}

% ENDING ---------------------------------
\newcommand{\makeendframe}{
\vspace{2.5cm} % spacing
\huge\centerline{\hspace{1.2cm}\textcolor{white}\ending}
\vspace{.7cm}
\normalsize{\centerline{\hspace{1.2cm}\textcolor{white}{\auth}}}
\medskip
\centering\hspace{1.2cm}\href{mailto:\email}{\texttt{\textcolor{white}{\email}}}
}